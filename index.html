<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅遊行程規劃表</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body data-theme="light">
    
    <header class="app-header">
        <div class="header-top">
            <div class="header-titles">
                <h1>泰國曼谷五日遊</h1>
                <p class="subtitle">日期: 2025/11/25 - 2025/11/29</p>
            </div>
            <div class="header-controls">
                <button class="icon-btn copy-btn" id="copy-data-btn" title="複製行程資料">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="icon-btn" id="theme-toggle-btn" title="切換深色模式" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="icon-btn edit-toggle-btn" id="edit-mode-btn" title="切換編輯模式" onclick="toggleEditMode()">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
        </div>
    </header>

    <nav class="day-nav">
        <div class="nav-container" id="day-nav-container">
            <button class="nav-btn active" data-day="1">Day 1</button>
            <button class="nav-btn" data-day="2">Day 2</button>
            <button class="nav-btn" data-day="3">Day 3</button>
            </div>
    </nav>

    <main class="schedule-container" id="schedule-container">
        
        <h2 class="day-theme" id="current-day-theme">Day 1 - 城市探索日</h2>

        <div class="timeline" id="timeline">
            
            </div>

        <div class="daily-summary">
            <div class="total-label">Day 1 預計總花費</div>
            <div class="total-amount">฿ 1500</div>
            <button class="reset-btn" onclick="resetDayTotal()">重設本日總額</button>
        </div>

        <button class="add-event-btn" id="add-event-btn" onclick="openModal('add')">
            <i class="fas fa-plus"></i> 新增行程事件
        </button>

    </main>

    <div class="edit-modal" id="event-modal">
        <div class="modal-content">
            <h3 id="modal-title">新增事件</h3>
            <form id="event-form">
                <input type="hidden" id="event-id">
                
                <div class="form-group">
                    <label for="event-time">時間</label>
                    <input type="time" id="event-time-input" required>
                </div>
                
                <div class="form-group">
                    <label for="event-location">地點</label>
                    <input type="text" id="event-location-input" required>
                </div>

                <div class="form-group">
                    <label for="event-transport">交通方式 (ex: walk, bts, car)</label>
                    <input type="text" id="event-transport-input">
                </div>

                <div class="form-group">
                    <label for="event-notes">備註 (支援多行)</label>
                    <textarea id="event-notes-input" rows="5"></textarea>
                </div>
                
                <div class="button-group">
                    <button type="button" class="cancel-btn" onclick="closeModal()">取消</button>
                    <button type="submit" class="save-btn">儲存</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="toast-notification"></div>

    <script>
        // ----------------------------------------------------------------------
        // 您提供的 JS 邏輯 (已包含備註美化與收合功能)
        // ----------------------------------------------------------------------

        // 核心高亮關鍵字列表
        const keywords = [
            "免費廁所", "收費廁所", "廁所沒衛生紙", "廁所",
            "17點關門", "10點才開", "17點前要入場",
            "1號出口", "2號出口", "4號出口", "GF 2號門",
            "先去換匯", "換匯",
            "左邊",
            // 針對您的樓層資訊，增加一些常見的亮點關鍵字，讓它更美觀
            "泰奶", "冰沙", "咖啡", "水舞", "觀景台", "瀑布", "室內水上市場", "Apple"
        ];

        // 核心高亮邏輯
        function applyHighlight(text) {
            if (!text) return "";
            let processedText = text;
            keywords.forEach(keyword => {
                // 使用 (keyword) 進行捕獲組替換
                const regex = new RegExp(`(${keyword})`, 'g');
                // 使用 <span class="highlight"> 應用樣式
                processedText = processedTextText.replace(regex, '<span class="highlight">$1</span>');
            });
            return processedText;
        }

        // 處理備註的排版和收合邏輯
        function formatNotes(notesText, eventId) {
            if (!notesText) return "";

            // 1. 按換行符分割成多行，並移除空行
            const lines = notesText.split('\n').map(line => line.trim()).filter(line => line.length > 0);

            if (lines.length === 0) return "";

            // 2. 對每一行應用高亮，並用 <p> 標籤包裹
            const formattedLines = lines.map(line => `<p>${applyHighlight(line)}</p>`).join('');

            const MAX_VISIBLE_LINES = 3; // 超過 3 行開始收合
            
            if (lines.length <= MAX_VISIBLE_LINES) {
                // 行數不多，直接顯示
                return `<div class="event-notes">${formattedLines}</div>`;
            }

            // 行數過多，創建收合容器
            const collapsedContent = lines.slice(0, MAX_VISIBLE_LINES).map(line => `<p>${applyHighlight(line)}</p>`).join('');
            const hiddenContent = lines.slice(MAX_VISIBLE_LINES).map(line => `<p>${applyHighlight(line)}</p>`).join('');

            const toggleButtonId = `toggle-notes-${eventId}`;
            const hiddenContentId = `hidden-notes-${eventId}`;

            return `
                <div class="event-notes notes-collapsible" data-event-id="${eventId}">
                    <div class="notes-visible-part">
                        ${collapsedContent}
                    </div>
                    <div class="notes-hidden-part" id="${hiddenContentId}">
                        ${hiddenContent}
                    </div>
                    <button class="notes-toggle-btn" id="${toggleButtonId}" onclick="toggleNotes('${hiddenContentId}', '${toggleButtonId}')">
                        ... 展開 ${lines.length - MAX_VISIBLE_LINES} 條備註
                    </button>
                </div>
            `;
        }

        // 全局收合/展開函式
        function toggleNotes(contentId, buttonId) {
            const content = document.getElementById(contentId);
            const button = document.getElementById(buttonId);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                // 由於我們不知道隱藏內容的確切行數，使用總行數減去可見行數作為按鈕顯示
                const totalHiddenLines = content.querySelectorAll('p').length;
                button.innerHTML = `... 展開 ${totalHiddenLines} 條備註`;
            } else {
                content.classList.add('expanded');
                button.innerHTML = '▲ 收合備註';
            }
        }
        
        // ----------------------------------------------------------------------
        // 額外需要的功能骨架 (模擬資料與基本操作)
        // ----------------------------------------------------------------------
        
        const scheduleData = [
            {
                id: 1, time: "09:00", location: "ICONSIAM", transport: "BTS/Boat", cost: 0, completed: false,
                notes: `G、UG樓 - 室內水上市場、 Lung Ngen Coffee(泰奶60)、Karun(泰奶冰沙110 糖40%)、ChaTraMue、小蜜蜂泰式脆皮可麗餅3個60\n2樓 - 暹羅天地公園(Apple門市外)、The Selected\n3樓 - Loft(帆布包)\n4樓 - ICONCRAFT\n5樓 - ECOTOPIA(buffollow)\n6樓 - 沉浸式體驗(BLOOM in Four Seasons)\n7樓 - 瀑布水舞、觀景台`
            },
            {
                id: 2, time: "14:00", location: "午餐 - ICONSIAM 美食廣場", transport: "Walk", cost: 450, completed: false, notes: "先去換匯，換匯點在UG層，記得問清楚匯率！"
            },
            {
                id: 3, time: "18:30", location: "Asiatique 碼頭夜市", transport: "Boat", cost: 0, completed: false, notes: "免費接駁船，晚上很涼快。"
            }
        ];
        
        const timelineEl = document.getElementById('timeline');

        // 渲染單個事件卡片
        function renderEvent(event) {
            const transportClass = event.transport ? `trans-${event.transport.toLowerCase().replace(/[^a-z0-9]/g, '')}` : '';
            const completedClass = event.completed ? ' completed' : '';
            const formattedNotes = formatNotes(event.notes, event.id); // 使用您提供的格式化函數

            return `
                <div class="event-card${completedClass}" data-id="${event.id}">
                    <div class="event-header">
                        <span class="event-time">${event.time}</span>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" onchange="toggleCompleted(${event.id}, this.checked)" ${event.completed ? 'checked' : ''}>
                        </div>
                    </div>
                    
                    <div class="event-location-group">
                        <i class="fas fa-map-marker-alt map-icon"></i>
                        <span class="event-location">${event.location}</span>
                    </div>

                    <div class="event-details">
                        <span class="badge ${transportClass}"><i class="fas fa-route"></i> ${event.transport || '未知'}</span>
                        <span class="cost-section" onclick="promptForCost(${event.id}, ${event.cost})">
                            <i class="fas fa-baht-sign"></i> ฿ <span class="event-cost-amount">${event.cost}</span>
                        </span>
                        
                        <div class="edit-controls" style="display: none;">
                            <button onclick="openModal('edit', ${event.id})" title="編輯">
                                <i class="fas fa-pencil-alt edit-icon"></i>
                            </button>
                            <button onclick="deleteEvent(${event.id})" title="刪除">
                                <i class="fas fa-trash-alt delete-icon"></i>
                            </button>
                        </div>
                    </div>
                    
                    ${formattedNotes}
                </div>
            `;
        }
        
        // 渲染所有事件
        function renderSchedule() {
            timelineEl.innerHTML = scheduleData.map(renderEvent).join('');
            
            // 根據編輯模式狀態顯示/隱藏編輯控制項
            updateEditControlsVisibility(isEditMode); 
        }

        // 模擬其他必要功能 (僅提供骨架)
        function toggleCompleted(id, completed) {
            const event = scheduleData.find(e => e.id === id);
            if (event) {
                event.completed = completed;
                renderSchedule();
            }
        }
        
        // Modal 相關操作 (骨架)
        const modal = document.getElementById('event-modal');
        function openModal(mode, id = null) {
            modal.classList.add('visible');
            // ... 實際的表單填充邏輯 ...
        }
        function closeModal() {
            modal.classList.remove('visible');
        }
        function deleteEvent(id) { /* ... 刪除邏輯 ... */ }
        function promptForCost(id, currentCost) { /* ... 費用修改邏輯 ... */ }
        function resetDayTotal() { /* ... 重設總額邏輯 ... */ }
        
        // 深色模式切換 (骨架)
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
        }
        
        // 編輯模式切換 (骨架)
        let isEditMode = false;
        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.getElementById('edit-mode-btn').classList.toggle('active', isEditMode);
            document.getElementById('add-event-btn').style.display = isEditMode ? 'block' : 'none';
            updateEditControlsVisibility(isEditMode);
        }
        
        function updateEditControlsVisibility(visible) {
            document.querySelectorAll('.edit-controls').forEach(el => {
                el.style.display = visible ? 'flex' : 'none';
            });
        }

        // 初始化渲染
        document.addEventListener('DOMContentLoaded', renderSchedule);

        // 模擬複製功能
        document.getElementById('copy-data-btn').addEventListener('click', () => {
             const toast = document.getElementById('toast-notification');
             toast.textContent = '行程資料已複製！(模擬)';
             toast.classList.add('visible');
             setTimeout(() => {
                 toast.classList.remove('visible');
             }, 3000);
        });

    </script>
</body>
</html>
