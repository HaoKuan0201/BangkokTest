<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›¼è°·äº”æ—¥è‡ªç”±è¡Œ</title>

    <link rel="stylesheet" href="style.css">
    </head>
<body>

    <header class="app-header">
        <div class="header-top">
            <div class="header-titles">
                <h1>æ›¼è°·äº”æ—¥è‡ªç”±è¡Œ</h1>
                <p class="subtitle">11/27 (å››) - 12/1 (ä¸€)</p>
            </div>
            
            <div class="header-controls">

                <button id="theme-toggle-btn" class="icon-btn theme-toggle-btn" title="åˆ‡æ›æ·±è‰²/æ·ºè‰²ä¸»é¡Œ">
    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
    </svg>
</button>
                
                <a href="https://www.google.com/maps/d/u/0/edit?mid=1pJlG73WanZkVkTSFvt3GLpMCDVU8heQ&ll=13.798196927110428%2C100.54907266665649&z=17" 
                    target="_blank" 
                    id="map-bookmark-btn" 
                    class="icon-btn map-bookmark-btn" 
                    title="æŸ¥çœ‹è¡Œç¨‹åœ°åœ–æ›¸ç±¤">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6">
                        <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/>
                        <line x1="16" x2="16" y1="2" y2="22"/>
                        <line x1="8" x2="8" y1="2" y2="18"/>
                    </svg>
                </a>
                
                <button id="copy-data-btn" class="icon-btn copy-btn" onclick="copyAppDataToClipboard()" title="è¤‡è£½æ‰€æœ‰æ•¸æ“š">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6">
                        <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                    </svg>
                </button>
                
                <button id="edit-toggle-btn" class="icon-btn edit-toggle-btn" onclick="toggleEditMode()" title="åˆ‡æ›ç·¨è¼¯æ¨¡å¼">
                    <svg id="edit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6">
                        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>
    
    <div id="toast-notification"></div>

    <nav class="day-nav">
        <div class="nav-container" id="nav-container">
            </div>
    </nav>

    <main id="schedule-container" class="schedule-container">
        </main>
    
    <div id="edit-modal" class="edit-modal">
        <div class="modal-content">
            <h3 id="modal-title">ç·¨è¼¯è¡Œç¨‹</h3>
            <form id="event-form">
                <input type="hidden" id="event-day-index">
                <input type="hidden" id="event-index">

                <div class="form-group">
                    <label for="event-time-input">æ™‚é–“ (æ ¼å¼: HH:MM æˆ– HH:MM-HH:MM)</label>
                    <input type="text" id="event-time-input" required>
                </div>

                <div class="form-group">
                    <label for="event-location-input">åœ°é»/æ´»å‹•</label>
                    <input type="text" id="event-location-input" required>
                </div>
                
                <div class="form-group">
                    <label for="event-map-url-input">åœ°åœ–é€£çµ (å¯é¸)</label>
                    <input type="url" id="event-map-url-input">
                </div>

                <div class="form-group">
                    <label for="event-note-url-input">å‚™è¨»é€£çµ (å¯é¸ï¼Œä¾‹å¦‚é è¨‚ç¶²å€)</label>
                    <input type="url" id="event-note-url-input">
                </div>

                <div class="form-group">
                    <label for="event-transport-input">äº¤é€šæ–¹å¼ (ä¾‹å¦‚: æ­¥è¡Œ, BTS, Bolt)</label>
                    <input type="text" id="event-transport-input" required>
                </div>

                <div class="form-group">
                    <label for="event-estimated-cost-input">é ä¼°èŠ±è²» (æ³°éŠ–)</label>
                    <input type="number" id="event-estimated-cost-input" value="0" min="0">
                </div>
                
                <div class="form-group">
                    <label for="event-notes-input">å‚™è¨» (å¯é¸)</label>
                    <textarea id="event-notes-input" rows="3"></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="cancel-btn" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button type="submit" class="save-btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- GitHub è¨­ç½® ---
        // âš ï¸ è­¦ç¤ºï¼šåªæœ‰æ‚¨è‡ªå·±ä½¿ç”¨é€™å€‹å·¥å…·æ™‚ï¼Œæ‰å¯å°‡ PAT å¯«åœ¨é€™è£¡
        const GITHUB_PAT = 'TODO: [è«‹æ›¿æ›ç‚ºæ‚¨çš„ Personal Access Token]';
        const GITHUB_USER = 'TODO: [è«‹æ›¿æ›ç‚ºæ‚¨çš„ GitHub å¸³è™Ÿ]';
        const REPO_NAME = 'TODO: [è«‹æ›¿æ›ç‚ºæ‚¨çš„å„²å­˜åº«åç¨±]';
        const FILE_PATH = 'originalTripData.js'; // æª”æ¡ˆåç¨±
        const BRANCH = 'main'; // åˆ†æ”¯åç¨± (å¯èƒ½æ˜¯ main æˆ– master)

        const RAW_FILE_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO_NAME}/${BRANCH}/${FILE_PATH}`;
        const API_CONTENTS_URL = `https://api.github.com/repos/${GITHUB_USER}/${REPO_NAME}/contents/${FILE_PATH}`;

        // --- å…¨å±€è®Šé‡å’Œæ•¸æ“šè™•ç† ---
        const STORAGE_KEY = 'bangkokTripData';
        const CHECK_KEY_SUFFIX = '_done';
        const COST_KEY_SUFFIX = '_cost';

        let appData = {};
        let currentDayIndex = 0;
        let isEditMode = false;
        let currentFileSha = ''; // ç”¨æ–¼ GitHub API å„²å­˜æ™‚çš„ç‰ˆæœ¬æ§åˆ¶

        // --- åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ ---
        document.addEventListener('DOMContentLoaded', async () => {
            // åœ¨æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚ï¼Œç•°æ­¥è¼‰å…¥ GitHub ä¸Šçš„æœ€æ–°è³‡æ–™
            await initAppDataFromGitHub();
            
            initApp();
            document.getElementById('event-form').addEventListener('submit', handleSaveEvent);
        });

        // --- æ•¸æ“šæŒä¹…åŒ– ---

        /**
         * 1. è¼‰å…¥è³‡æ–™ (å¾ GitHub)
         * - é€™æ˜¯æ–°çš„è®€å–é‚è¼¯ï¼Œå–ä»£äº†éœæ…‹ <script> æ¨™ç±¤å’Œ LocalStorage è®€å–ä¸»è¦è³‡æ–™ã€‚
         */
        async function initAppDataFromGitHub() {
            showToast('ğŸ”„ æ­£åœ¨å¾ GitHub è¼‰å…¥æœ€æ–°è¡Œç¨‹è³‡æ–™...');
            try {
                // 1. å¾ Raw URL è¼‰å…¥å…§å®¹
                const rawResponse = await fetch(RAW_FILE_URL);
                if (!rawResponse.ok) {
                     // å¦‚æœ raw é€£çµç„¡æ•ˆï¼Œå˜—è©¦å¾ API ç²å– SHA å’Œå…§å®¹
                    const apiResponse = await fetch(API_CONTENTS_URL, {
                        headers: {
                            'Authorization': `token ${GITHUB_PAT}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!apiResponse.ok) {
                        throw new Error(`GitHub è®€å–éŒ¯èª¤: ${apiResponse.statusText}`);
                    }
                    
                    const apiData = await apiResponse.json();
                    currentFileSha = apiData.sha;
                    
                    // GitHub API è¿”å›çš„å…§å®¹æ˜¯ Base64 ç·¨ç¢¼ï¼Œéœ€è¦è§£ç¢¼
                    const rawContent = atob(apiData.content); 
                    appData = parseTripData(rawContent);

                } else {
                    const rawContent = await rawResponse.text();
                    appData = parseTripData(rawContent);
                    
                    // 2. é †ä¾¿è®€å– SHA (ç‚ºäº†å¯«å›ï¼Œéœ€è¦ PAT)
                    const shaResponse = await fetch(API_CONTENTS_URL, {
                        headers: {
                            'Authorization': `token ${GITHUB_PAT}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (shaResponse.ok) {
                        const shaData = await shaResponse.json();
                        currentFileSha = shaData.sha;
                    } else {
                        console.error('ç„¡æ³•å–å¾— SHAï¼Œå¯«å…¥åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨ï¼è«‹æª¢æŸ¥ PAT å’Œå„²å­˜åº«åç¨±ã€‚');
                    }
                }
                
                showToast('âœ… è³‡æ–™è¼‰å…¥æˆåŠŸï¼');
                
            } catch (error) {
                console.error('ç„¡æ³•å¾ GitHub è¼‰å…¥è³‡æ–™:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯ã€PAT æˆ–æª”æ¡ˆè·¯å¾‘ã€‚');
                
                // å¤±æ•—æ™‚ï¼Œåˆå§‹åŒ–ä¸€å€‹ç©ºçš„æˆ–å‚™ç”¨çµæ§‹
                appData = { days: [] }; 
            }
        }
        
        // è¼”åŠ©å‡½æ•¸ï¼šè§£æ originalTripData.js çš„å…§å®¹
        function parseTripData(content) {
            try {
                // å‡è¨­ originalTripData.js æª”æ¡ˆå…§å®¹æ ¼å¼ç‚º: const originalTripData = { ... };
                const match = content.match(/const originalTripData = (\{[\s\S]*?\});/);
                if (match && match[1]) {
                    return JSON.parse(match[1]);
                }
                // å¦‚æœæª”æ¡ˆåªæ˜¯ç´” JSON (æ²’æœ‰ const originalTripData = )
                return JSON.parse(content);
            } catch (e) {
                console.error("è§£æè³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿ originalTripData.js æ ¼å¼æ­£ç¢º", e);
                return { days: [] };
            }
        }
        
        /**
         * 2. å„²å­˜è³‡æ–™ (å¯«å› GitHub)
         * - ä½¿ç”¨ GitHub Contents API çš„ PUT æ–¹æ³•ã€‚
         */
        async function saveToGitHub() {
            if (!currentFileSha || !GITHUB_PAT) {
                showToast('âŒ ç„¡æ³•å„²å­˜ï¼šç¼ºå°‘ SHA æˆ– PATã€‚');
                return false;
            }
            
            showToast('ğŸ”„ æ­£åœ¨å„²å­˜è®Šæ›´ä¸¦åŒæ­¥è‡³ GitHub...');

            // æ ¼å¼åŒ–ç‚º originalTripData.js æ‰€éœ€çš„å…§å®¹å­—ä¸²
            const formattedContent = `const originalTripData = ${JSON.stringify(appData, null, 4)};\n`;
            
            // å¯«å…¥ GitHub API å¿…é ˆæ˜¯ Base64 ç·¨ç¢¼
            const base64Content = btoa(formattedContent);
            
            const payload = {
                message: `Update data via frontend tool - ${new Date().toLocaleString('zh-TW')}`, 
                content: base64Content,
                sha: currentFileSha, // å¿…é ˆåŒ…å«ç•¶å‰çš„ SHA
                branch: BRANCH
            };

            try {
                const response = await fetch(API_CONTENTS_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_PAT}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();

                if (response.ok) {
                    currentFileSha = data.content.sha; // æ›´æ–°æ–°çš„ SHA
                    showToast('ğŸ’¾ âœ… æ•¸æ“šå·²æˆåŠŸå¯«å…¥ GitHubï¼ç¶²é å°‡åœ¨æ•¸åˆ†é˜å¾Œæ›´æ–°ã€‚');
                    return true;
                } else {
                    console.error('GitHub å¯«å…¥å¤±æ•—:', data);
                    // è™•ç†æª”æ¡ˆè¡çªçš„å¯èƒ½éŒ¯èª¤
                    if (data.message && data.message.includes('sha')) {
                        showToast('âŒ å„²å­˜å¤±æ•—ï¼šç‰ˆæœ¬è¡çªï¼è«‹åˆ·æ–°é é¢é‡è©¦ã€‚');
                    } else {
                        showToast(`âŒ å„²å­˜å¤±æ•—: ${data.message || response.statusText}`);
                    }
                    return false;
                }
            } catch (error) {
                console.error('API å‘¼å«éŒ¯èª¤:', error);
                showToast('âŒ ç¶²è·¯æˆ– API å‘¼å«å¤±æ•—ã€‚');
                return false;
            }
        }
        
        // èˆŠçš„ saveData() å‡½å¼ç¾åœ¨ç”¨æ–¼ LocalStorage (åƒ…ç”¨æ–¼è¨˜å¸³ç­‰éæ ¸å¿ƒæ•¸æ“š)
        function saveData() {
             // èˆŠçš„ LocalStorage å„²å­˜é‚è¼¯ (åƒ…ä¿ç•™ LocalStorage ä¸­å„²å­˜çš„éæ ¸å¿ƒç‹€æ…‹)
        }
        
        // --- è¤‡è£½æ•¸æ“šåŠŸèƒ½ (è¤‡è£½åˆ°å‰ªè²¼ç°¿) ---
        window.copyAppDataToClipboard = function() {
            // è¤‡è£½æˆå®Œæ•´çš„ JS æª”æ¡ˆæ ¼å¼
            const dataToCopy = JSON.stringify(appData, null, 4); 
            const finalString = 'const originalTripData = ' + dataToCopy + ';';
            
            const textarea = document.createElement('textarea');
            textarea.value = finalString;
            textarea.style.position = 'fixed'; 
            textarea.style.left = '-9999px'; 
            document.body.appendChild(textarea);
            
            textarea.select();
            
            try {
                // ä½¿ç”¨ Clipboard API (æ›´ç¾ä»£)
                navigator.clipboard.writeText(finalString)
                    .then(() => {
                        showToast('âœ… æ•¸æ“šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                    })
                    .catch(err => {
                        console.error('Copy failed (Clipboard API):', err);
                        // Fallback to execCommand if Clipboard API fails
                        const successful = document.execCommand('copy');
                        if (successful) {
                            showToast('âœ… æ•¸æ“šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                        } else {
                            showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
                        }
                    });
            } catch (err) {
                // Fallback for older browsers
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('âœ… æ•¸æ“šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                } else {
                    showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
                }
            }
            
            document.body.removeChild(textarea);
        }
        
        // ... (å…¶ä»– showToast å‡½æ•¸ä¸è®Š) ...


        // --- æ ¸å¿ƒæ‡‰ç”¨é‚è¼¯ ---

        function initApp() {
            determineInitialDay();
            renderNavigation();
            renderDay(currentDayIndex);
            updateEditButtonUI();
        }
        
        // ... (determineInitialDay, renderNavigation, updateNavState, renderDay å‡½æ•¸ä¸è®Š) ...

        // --- ç·¨è¼¯æ¨¡å¼åŠŸèƒ½ & æ’åº ---
        
        // ... (getSortableTime, sortEventsByTime å‡½æ•¸ä¸è®Š) ...

        window.toggleEditMode = async function() {
            isEditMode = !isEditMode;
            
            if (!isEditMode) {
                // é€€å‡ºç·¨è¼¯æ¨¡å¼æ™‚ï¼ŒåŸ·è¡Œå„²å­˜åˆ° GitHub çš„æ“ä½œ
                const saveSuccess = await saveToGitHub();
                if (saveSuccess) {
                    // å¦‚æœå„²å­˜æˆåŠŸï¼Œæ‰æ›´æ–° UI ç‹€æ…‹
                    updateEditButtonUI();
                } else {
                    // å„²å­˜å¤±æ•—ï¼Œä¿æŒåœ¨ç·¨è¼¯æ¨¡å¼ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥é‡è©¦æˆ–è¤‡è£½æ•¸æ“š
                    isEditMode = true; 
                }
            } else {
                // é€²å…¥ç·¨è¼¯æ¨¡å¼ï¼Œç›´æ¥æ›´æ–° UI
                updateEditButtonUI();
            }
            
            renderDay(currentDayIndex);
        }

        // ... (updateEditButtonUI, openEditModal, closeEditModal, startEditEvent, startAddEvent å‡½æ•¸ä¸è®Š) ...

        // å„²å­˜äº‹ä»¶è™•ç† (åŒ…å«æ’åºé‚è¼¯)
        function handleSaveEvent(e) {
            e.preventDefault();
            
            const dayIndex = parseInt(document.getElementById('event-day-index').value);
            const eventIndex = parseInt(document.getElementById('event-index').value);

            const newEvent = {
                time: document.getElementById('event-time-input').value,
                location: document.getElementById('event-location-input').value,
                mapURL: document.getElementById('event-map-url-input').value.trim(),
                noteURL: document.getElementById('event-note-url-input').value.trim(),
                transport: document.getElementById('event-transport-input').value,
                cost: document.getElementById('event-estimated-cost-input').value || '0',
                notes: document.getElementById('event-notes-input').value
            };

            if (eventIndex === -1) {
                // æ–°å¢
                appData.days[dayIndex].events.push(newEvent);
                showToast('âœ¨ è¡Œç¨‹å·²æ–°å¢è‡³æœ¬åœ°æ•¸æ“šã€‚');
            } else {
                // ä¿®æ”¹
                appData.days[dayIndex].events[eventIndex] = newEvent;
                showToast('ğŸ“ è¡Œç¨‹å·²æ›´æ–°è‡³æœ¬åœ°æ•¸æ“šã€‚');
            }

            // æ’åºç•¶æ—¥æ‰€æœ‰è¡Œç¨‹
            sortEventsByTime(appData.days[dayIndex].events);

            // åœ¨é€™è£¡ä¸å†å‘¼å« saveData() (å› ç‚ºæˆ‘å€‘åªåœ¨é€€å‡ºç·¨è¼¯æ¨¡å¼æ™‚æ‰å¯«å…¥ GitHub)
            closeEditModal();
            renderDay(dayIndex);
        }

        // åˆªé™¤äº‹ä»¶è™•ç†
        window.deleteEvent = function(dayIndex, eventIndex) {
             if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ")) return;

            // ç§»é™¤è¡Œç¨‹
            appData.days[dayIndex].events.splice(eventIndex, 1);
            showToast('ğŸ—‘ï¸ è¡Œç¨‹å·²å¾æœ¬åœ°æ•¸æ“šåˆªé™¤ã€‚');

            // åˆªé™¤ç›¸é—œçš„ LocalStorage æ•¸æ“š (è¨˜å¸³/å®Œæˆç‹€æ…‹)
            localStorage.removeItem(`trip_d${dayIndex}_e${eventIndex}${CHECK_KEY_SUFFIX}`);
            localStorage.removeItem(`trip_d${dayIndex}_e${eventIndex}${COST_KEY_SUFFIX}`);
            
            // é‡æ–°æ’åºä¸¦æ¸²æŸ“
            sortEventsByTime(appData.days[dayIndex].events);
            renderDay(dayIndex);
        }


        // ... (æ‰€æœ‰èˆ‡è¨˜å¸³ã€ä¸»é¡Œåˆ‡æ›ã€æ»¾å‹•ç›¸é—œçš„å‡½æ•¸ä¿æŒä¸è®Š) ...
        // åŒ…æ‹¬ï¼šhighlightKeywords, toggleComplete, enableCostEdit, saveCost, resetDailyCosts, 
        // themeToggleBtn, updateThemeIcon, æ»¾å‹•ç›¸é—œé‚è¼¯
    </script>
</body>
</html>
