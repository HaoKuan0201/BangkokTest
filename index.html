<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›¼è°·äº”æ—¥è‡ªç”±è¡Œ</title>

    <link rel="stylesheet" href="style.css">
    </head>
<body>

    <header class="app-header">
        <div class="header-top">
            <div class="header-titles">
                <h1>æ›¼è°·äº”æ—¥è‡ªç”±è¡Œ</h1>
                <p class="subtitle">11/27 (å››) - 12/1 (ä¸€)</p>
            </div>
            
            <div class="header-controls">

                <button id="theme-toggle-btn" class="icon-btn theme-toggle-btn" title="åˆ‡æ›æ·±è‰²/æ·ºè‰²ä¸»é¡Œ">
    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
    </svg>
</button>
                
                <a href="https://www.google.com/maps/d/u/0/edit?mid=1pJlG73WanZkVkTSFvt3GLpMCDVU8heQ&ll=13.798196927110428%2C100.54907266665649&z=17" 
                    target="_blank" 
                    id="map-bookmark-btn" 
                    class="icon-btn map-bookmark-btn" 
                    title="æŸ¥çœ‹è¡Œç¨‹åœ°åœ–æ›¸ç±¤">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6">
                        <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/>
                        <line x1="16" x2="16" y1="2" y2="22"/>
                        <line x1="8" x2="8" y1="2" y2="18"/>
                    </svg>
                </a>
                
                <button id="copy-data-btn" class="icon-btn copy-btn" onclick="copyAppDataToClipboard()" title="è¤‡è£½æ‰€æœ‰æ•¸æ“š">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6">
                        <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                    </svg>
                </button>
                
                <button id="edit-toggle-btn" class="icon-btn edit-toggle-btn" onclick="toggleEditMode()" title="åˆ‡æ›ç·¨è¼¯æ¨¡å¼">
                    <svg id="edit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6">
                        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>
    
    <div id="toast-notification"></div>

    <nav class="day-nav">
        <div class="nav-container" id="nav-container">
            </div>
    </nav>

    <main id="schedule-container" class="schedule-container">
        </main>
    
    <div id="edit-modal" class="edit-modal">
        <div class="modal-content">
            <h3 id="modal-title">ç·¨è¼¯è¡Œç¨‹</h3>
            <form id="event-form">
                <input type="hidden" id="event-day-index">
                <input type="hidden" id="event-index">

                <div class="form-group">
                    <label for="event-time-input">æ™‚é–“ (æ ¼å¼: HH:MM æˆ– HH:MM-HH:MM)</label>
                    <input type="text" id="event-time-input" required>
                </div>

                <div class="form-group">
                    <label for="event-location-input">åœ°é»/æ´»å‹•</label>
                    <input type="text" id="event-location-input" required>
                </div>
                
                <div class="form-group">
                    <label for="event-map-url-input">åœ°åœ–é€£çµ (å¯é¸)</label>
                    <input type="url" id="event-map-url-input">
                </div>

                <div class="form-group">
                    <label for="event-note-url-input">å‚™è¨»é€£çµ (å¯é¸ï¼Œä¾‹å¦‚é è¨‚ç¶²å€)</label>
                    <input type="url" id="event-note-url-input">
                </div>

                <div class="form-group">
                    <label for="event-transport-input">äº¤é€šæ–¹å¼ (ä¾‹å¦‚: æ­¥è¡Œ, BTS, Bolt)</label>
                    <input type="text" id="event-transport-input" required>
                </div>

                <div class="form-group">
                    <label for="event-estimated-cost-input">é ä¼°èŠ±è²» (æ³°éŠ–)</label>
                    <input type="number" id="event-estimated-cost-input" value="0" min="0">
                </div>
                
                <div class="form-group">
                    <label for="event-notes-input">å‚™è¨» (å¯é¸)</label>
                    <textarea id="event-notes-input" rows="3"></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="cancel-btn" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button type="submit" class="save-btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- GitHub è¨­ç½® ---
        // âš ï¸ è­¦ç¤ºï¼šåªæœ‰æ‚¨è‡ªå·±ä½¿ç”¨é€™å€‹å·¥å…·æ™‚ï¼Œæ‰å¯å°‡ PAT å¯«åœ¨é€™è£¡
        const GITHUB_PAT = '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';
        const GITHUB_USER = 'HaoKuan0201';
        const REPO_NAME = 'BangkokTest';
        const FILE_PATH = 'originalTripData.js'; // æª”æ¡ˆåç¨±
        const BRANCH = 'main'; // åˆ†æ”¯åç¨± (å¯èƒ½æ˜¯ main æˆ– master)

        const RAW_FILE_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO_NAME}/${BRANCH}/${FILE_PATH}`;
        const API_CONTENTS_URL = `https://api.github.com/repos/${GITHUB_USER}/${REPO_NAME}/contents/${FILE_PATH}`;

        // --- å…¨å±€è®Šé‡å’Œæ•¸æ“šè™•ç† ---
        const STORAGE_KEY = 'bangkokTripData';
        const CHECK_KEY_SUFFIX = '_done';
        const COST_KEY_SUFFIX = '_cost';

        // æ¨¡æ“¬æ•¸æ“šçµæ§‹ (åœ¨ GitHub è¼‰å…¥å¤±æ•—æ™‚ä½¿ç”¨)
        const MOCK_DATA = {
            title: "æ›¼è°·äº”æ—¥è‡ªç”±è¡Œ (æ¨¡æ“¬æ•¸æ“š)",
            dateRange: "11/27 (å››) - 12/1 (ä¸€)",
            days: [
                {
                    dayName: "Day 1",
                    date: "11/27 (å››)",
                    events: [
                        { time: "09:00", location: "æ¡ƒåœ’æ©Ÿå ´ (TPE)", mapURL: "", noteURL: "", transport: "é£›æ©Ÿ", cost: "3000", notes: "é•·æ¦®èˆªç©º BR75" },
                        { time: "12:00", location: "ç´ è¬é‚£æ™®æ©Ÿå ´ (BKK)", mapURL: "", noteURL: "", transport: "æ©Ÿå ´å¿«ç·š", cost: "45", notes: "è¾¦ç†è½åœ°ç°½" },
                        { time: "14:00", location: "Siam Paragon", mapURL: "https://goo.gl/maps/example", noteURL: "", transport: "BTS", cost: "300", notes: "è³¼ç‰©ä¸­å¿ƒåˆé¤" }
                    ]
                },
                {
                    dayName: "Day 2",
                    date: "11/28 (äº”)",
                    events: [
                        { time: "10:00", location: "å¤§çš‡å®® (The Grand Palace)", mapURL: "https://goo.gl/maps/example2", noteURL: "", transport: "è¨ˆç¨‹è»Š", cost: "500", notes: "éœ€ç©¿è‘—æ­£å¼æœè£" },
                        { time: "18:30", location: "Asiatique The Riverfront", mapURL: "https://goo.gl/maps/example3", noteURL: "", transport: "èˆ¹", cost: "800", notes: "å¤œå¸‚æ™šé¤å’Œæ‘©å¤©è¼ª" }
                    ]
                }
            ]
        };

        let appData = MOCK_DATA; // é è¨­ç‚ºæ¨¡æ“¬æ•¸æ“šï¼Œå°‡è¢« GitHub æ•¸æ“šè¦†è“‹
        let currentDayIndex = 0;
        let isEditMode = false;
        let currentFileSha = ''; // ç”¨æ–¼ GitHub API å„²å­˜æ™‚çš„ç‰ˆæœ¬æ§åˆ¶
        
        // åˆå§‹åŒ–ä¸»é¡Œç‹€æ…‹
        const isDarkMode = localStorage.getItem('theme') === 'dark';
        if (isDarkMode) {
            document.documentElement.classList.add('dark-mode');
        }

        // --- åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ (æ‚¨åŸæœ¬æä¾›çš„éƒ¨åˆ†) ---
        document.addEventListener('DOMContentLoaded', async () => {
            // åœ¨æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚ï¼Œç•°æ­¥è¼‰å…¥ GitHub ä¸Šçš„æœ€æ–°è³‡æ–™
            await initAppDataFromGitHub();
            
            initApp();
            document.getElementById('event-form').addEventListener('submit', handleSaveEvent);
            updateThemeIcon(isDarkMode); // ç¢ºä¿ä¸»é¡ŒæŒ‰éˆ•åœ–æ¨™æ­£ç¢º
        });

        // --- æ•¸æ“šæŒä¹…åŒ– (æ‚¨åŸæœ¬æä¾›çš„éƒ¨åˆ†) ---

        /**
         * 1. è¼‰å…¥è³‡æ–™ (å¾ GitHub)
         */
        async function initAppDataFromGitHub() {
            showToast('ğŸ”„ æ­£åœ¨å¾ GitHub è¼‰å…¥æœ€æ–°è¡Œç¨‹è³‡æ–™...');
            try {
                // 1. å¾ API ç²å– SHA å’Œå…§å®¹ (ç¢ºä¿æˆ‘å€‘èƒ½ç²å–åˆ° SHAï¼Œå¦å‰‡ç„¡æ³•å¯«å›)
                const apiResponse = await fetch(API_CONTENTS_URL, {
                    headers: {
                        'Authorization': `token ${GITHUB_PAT}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!apiResponse.ok) {
                    throw new Error(`GitHub è®€å–éŒ¯èª¤: ${apiResponse.statusText}`);
                }
                
                const apiData = await apiResponse.json();
                currentFileSha = apiData.sha;
                
                // GitHub API è¿”å›çš„å…§å®¹æ˜¯ Base64 ç·¨ç¢¼ï¼Œéœ€è¦è§£ç¢¼
                const rawContent = atob(apiData.content); 
                const loadedData = parseTripData(rawContent);

                // æª¢æŸ¥è¼‰å…¥çš„è³‡æ–™æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæœ‰æ•ˆå‰‡è¦†è“‹æ¨¡æ“¬æ•¸æ“š
                if (loadedData && loadedData.days && loadedData.days.length > 0) {
                    appData = loadedData;
                    showToast('âœ… è³‡æ–™è¼‰å…¥æˆåŠŸï¼');
                } else {
                     showToast('âš ï¸ GitHub è³‡æ–™ç‚ºç©ºæˆ–æ ¼å¼éŒ¯èª¤ï¼Œä½¿ç”¨æ¨¡æ“¬æ•¸æ“šã€‚');
                }

            } catch (error) {
                console.error('ç„¡æ³•å¾ GitHub è¼‰å…¥è³‡æ–™:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯ã€PAT æˆ–æª”æ¡ˆè·¯å¾‘ã€‚å°‡ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šã€‚');
                // å¤±æ•—æ™‚ï¼Œä¿æŒä½¿ç”¨ MOCK_DATA
                appData = MOCK_DATA;
                currentFileSha = ''; // å¯«å…¥åŠŸèƒ½å°‡è¢«ç¦ç”¨
            }
            // æ›´æ–°é é¢æ¨™é¡Œ
            document.querySelector('.header-titles h1').textContent = appData.title || 'æ›¼è°·äº”æ—¥è‡ªç”±è¡Œ';
            document.querySelector('.header-titles .subtitle').textContent = appData.dateRange || '';
        }
        
        // è¼”åŠ©å‡½æ•¸ï¼šè§£æ originalTripData.js çš„å…§å®¹
        function parseTripData(content) {
            try {
                // å‡è¨­ originalTripData.js æª”æ¡ˆå…§å®¹æ ¼å¼ç‚º: const originalTripData = { ... };
                const match = content.match(/const originalTripData = (\{[\s\S]*?\});/);
                if (match && match[1]) {
                    return JSON.parse(match[1]);
                }
                // å¦‚æœæª”æ¡ˆåªæ˜¯ç´” JSON (æ²’æœ‰ const originalTripData = )
                return JSON.parse(content);
            } catch (e) {
                console.error("è§£æè³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿ originalTripData.js æ ¼å¼æ­£ç¢º", e);
                return { days: [] };
            }
        }
        
        /**
         * 2. å„²å­˜è³‡æ–™ (å¯«å› GitHub)
         */
        async function saveToGitHub() {
            if (!currentFileSha || !GITHUB_PAT) {
                showToast('âŒ ç„¡æ³•å„²å­˜ï¼šç¼ºå°‘ SHA æˆ– PATã€‚');
                return false;
            }
            
            showToast('ğŸ”„ æ­£åœ¨å„²å­˜è®Šæ›´ä¸¦åŒæ­¥è‡³ GitHub...');

            // æ ¼å¼åŒ–ç‚º originalTripData.js æ‰€éœ€çš„å…§å®¹å­—ä¸²
            const formattedContent = `const originalTripData = ${JSON.stringify(appData, null, 4)};\n`;
            
            // å¯«å…¥ GitHub API å¿…é ˆæ˜¯ Base64 ç·¨ç¢¼
            const base64Content = btoa(formattedContent);
            
            const payload = {
                message: `Update data via frontend tool - ${new Date().toLocaleString('zh-TW')}`, 
                content: base64Content,
                sha: currentFileSha, // å¿…é ˆåŒ…å«ç•¶å‰çš„ SHA
                branch: BRANCH
            };

            try {
                const response = await fetch(API_CONTENTS_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_PAT}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();

                if (response.ok) {
                    currentFileSha = data.content.sha; // æ›´æ–°æ–°çš„ SHA
                    showToast('ğŸ’¾ âœ… æ•¸æ“šå·²æˆåŠŸå¯«å…¥ GitHubï¼ç¶²é å°‡åœ¨æ•¸åˆ†é˜å¾Œæ›´æ–°ã€‚');
                    return true;
                } else {
                    console.error('GitHub å¯«å…¥å¤±æ•—:', data);
                    // è™•ç†æª”æ¡ˆè¡çªçš„å¯èƒ½éŒ¯èª¤
                    if (data.message && data.message.includes('sha')) {
                        showToast('âŒ å„²å­˜å¤±æ•—ï¼šç‰ˆæœ¬è¡çªï¼è«‹åˆ·æ–°é é¢é‡è©¦ã€‚');
                    } else {
                        showToast(`âŒ å„²å­˜å¤±æ•—: ${data.message || response.statusText}`);
                    }
                    return false;
                }
            } catch (error) {
                console.error('API å‘¼å«éŒ¯èª¤:', error);
                showToast('âŒ ç¶²è·¯æˆ– API å‘¼å«å¤±æ•—ã€‚');
                return false;
            }
        }
        
        // èˆŠçš„ saveData() å‡½å¼ (ä¿ç•™å…¶å®šç¾©ï¼Œä½†æ­¤è™•ä¸æœƒåŸ·è¡Œæ ¸å¿ƒæ•¸æ“šå„²å­˜ï¼Œåªç”¨æ–¼ LocalStorage ç‹€æ…‹)
        function saveData() {
             // æ­¤è™•åƒ…ä½œç‚ºä½”ä½ç¬¦ï¼Œå¦‚æœåŸç¨‹å¼ç¢¼æœ‰å…¶ä»– LocalStorage é‚è¼¯ï¼ˆå¦‚æ»¾å‹•ä½ç½®ï¼‰å‰‡æœƒæ”¾åœ¨é€™è£¡
        }
        
        // --- è¤‡è£½æ•¸æ“šåŠŸèƒ½ (æ‚¨åŸæœ¬æä¾›çš„éƒ¨åˆ†) ---
        window.copyAppDataToClipboard = function() {
            // ... (è¤‡è£½æ•¸æ“šé‚è¼¯ï¼Œç•¥éèˆ‡åŸå§‹ç¢¼ç›¸åŒéƒ¨åˆ†) ...
            const dataToCopy = JSON.stringify(appData, null, 4); 
            const finalString = 'const originalTripData = ' + dataToCopy + ';';
            
            const textarea = document.createElement('textarea');
            textarea.value = finalString;
            textarea.style.position = 'fixed'; 
            textarea.style.left = '-9999px'; 
            document.body.appendChild(textarea);
            
            textarea.select();
            
            try {
                // ä½¿ç”¨ Clipboard API
                navigator.clipboard.writeText(finalString)
                    .then(() => {
                        showToast('âœ… æ•¸æ“šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                    })
                    .catch(err => {
                        console.error('Copy failed (Clipboard API):', err);
                        const successful = document.execCommand('copy');
                        if (successful) {
                            showToast('âœ… æ•¸æ“šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                        } else {
                            showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
                        }
                    });
            } catch (err) {
                // Fallback for older browsers
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('âœ… æ•¸æ“šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                } else {
                    showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
                }
            }
            
            document.body.removeChild(textarea);
        }

        // --- æ ¸å¿ƒè¼”åŠ©åŠŸèƒ½ (ç¼ºå¤±éƒ¨åˆ†) ---
        
        /**
         * é¡¯ç¤º Toast é€šçŸ¥
         */
        let toastTimeout;
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            clearTimeout(toastTimeout);
            toast.textContent = message;
            toast.classList.add('show');
            
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        /**
         * ç¢ºå®šæ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚æ‡‰é¡¯ç¤ºå“ªä¸€å¤©çš„è¡Œç¨‹
         */
        function determineInitialDay() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            // å°‹æ‰¾æœ€è¿‘æˆ–ç•¶å¤©çš„æ—¥æœŸ
            const closestDayIndex = appData.days.findIndex(day => {
                const dayDate = new Date(day.date.split('(')[0].trim() + ' ' + today.getFullYear());
                dayDate.setHours(0, 0, 0, 0); 
                return dayDate >= today;
            });

            currentDayIndex = closestDayIndex !== -1 ? closestDayIndex : 0;
        }

        /**
         * æ¸²æŸ“å°èˆªæŒ‰éˆ•
         */
        function renderNavigation() {
            const navContainer = document.getElementById('nav-container');
            navContainer.innerHTML = '';
            
            appData.days.forEach((day, index) => {
                const button = document.createElement('button');
                button.className = `nav-btn text-sm sm:text-base ${index === currentDayIndex ? 'active' : ''}`;
                button.textContent = `${day.dayName} ${day.date.split('(')[0]}`; // åªé¡¯ç¤ºæ—¥æœŸéƒ¨åˆ†
                button.onclick = () => switchDay(index);
                navContainer.appendChild(button);
            });
            updateNavState();
        }

        /**
         * æ›´æ–°å°èˆªæŒ‰éˆ•çš„ active ç‹€æ…‹
         */
        function updateNavState() {
            document.querySelectorAll('.nav-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === currentDayIndex);
            });
            // æ»¾å‹•åˆ°é¸å®šçš„æŒ‰éˆ•
            const activeBtn = document.querySelector('.nav-btn.active');
            if (activeBtn) {
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        /**
         * åˆ‡æ›é¡¯ç¤ºçš„è¡Œç¨‹æ—¥
         */
        window.switchDay = function(index) {
            currentDayIndex = index;
            renderDay(currentDayIndex);
            updateNavState();
        }

        /**
         * æ¸²æŸ“ç‰¹å®šä¸€å¤©çš„è¡Œç¨‹å…§å®¹
         */
        function renderDay(dayIndex) {
            const container = document.getElementById('schedule-container');
            const dayData = appData.days[dayIndex];
            container.innerHTML = '';

            if (!dayData) {
                 container.innerHTML = `<div class="p-6 text-center text-gray-500 dark:text-gray-400">ç›®å‰æ²’æœ‰å¯ç”¨çš„è¡Œç¨‹æ•¸æ“šã€‚è«‹æª¢æŸ¥ GitHub é€£ç·šæˆ–é€²å…¥ç·¨è¼¯æ¨¡å¼æ–°å¢ã€‚</div>`;
                 return;
            }
            
            // ç¢ºä¿æ¯æ¬¡æ¸²æŸ“å‰éƒ½é€²è¡Œæ’åº
            sortEventsByTime(dayData.events);

            let totalEstimatedCost = 0;
            let totalActualCost = 0;

            // å»ºç«‹æ—¥è¡Œç¨‹å€å¡Š
            const daySection = document.createElement('div');
            daySection.id = `day-${dayIndex}`;
            daySection.className = 'day-section';
            
            // æ¨™é¡Œå’Œæ–°å¢æŒ‰éˆ•
            daySection.innerHTML = `
                <h2 class="flex justify-between items-center text-2xl">
                    ${dayData.dayName} - ${dayData.date}
                    ${isEditMode ? `<button onclick="startAddEvent(${dayIndex})" class="text-sm px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded-lg transition duration-150">
                        + æ–°å¢è¡Œç¨‹
                    </button>` : ''}
                </h2>
                <div class="event-list"></div>
                <div class="summary-block mt-6 p-4 rounded-lg bg-indigo-100 dark:bg-indigo-900 shadow-inner">
                    <p class="text-lg font-bold">æ¯æ—¥èŠ±è²»ç¸½çµ (æ³°éŠ–)</p>
                    <p class="text-sm mt-1">
                        é ä¼°ç¸½èŠ±è²»: <span class="font-semibold text-red-600 dark:text-red-400" id="estimated-cost-${dayIndex}">0</span>
                    </p>
                    <p class="text-xl font-extrabold mt-2 total-cost-display">
                        å¯¦éš›ç¸½èŠ±è²»: <span id="actual-cost-${dayIndex}">0</span> 
                        <button onclick="resetDailyCosts(${dayIndex})" title="é‡è¨­å¯¦éš›èŠ±è²»" class="text-xs text-gray-500 dark:text-gray-400 ml-2 hover:text-red-500">
                            [é‡è¨­]
                        </button>
                    </p>
                </div>
            `;
            const eventList = daySection.querySelector('.event-list');

            dayData.events.forEach((event, eventIndex) => {
                // å¾ LocalStorage ç²å–å®Œæˆç‹€æ…‹å’Œå¯¦éš›èŠ±è²»
                const isCompleted = localStorage.getItem(`trip_d${dayIndex}_e${eventIndex}${CHECK_KEY_SUFFIX}`) === 'true';
                const actualCost = localStorage.getItem(`trip_d${dayIndex}_e${eventIndex}${COST_KEY_SUFFIX}`) || event.cost;
                
                // è¨ˆç®—ç¸½å’Œ
                totalEstimatedCost += parseInt(event.cost || 0);
                totalActualCost += parseInt(actualCost || 0);

                // å¯¦éš›èŠ±è²»çš„é¡¯ç¤º/ç·¨è¼¯ UI
                let costHtml = `<span id="cost-display-${dayIndex}-${eventIndex}" 
                                        class="cost-display cursor-pointer" 
                                        onclick="enableCostEdit(${dayIndex}, ${eventIndex}, ${event.cost || 0})">
                                        THB ${actualCost}
                                    </span>`;
                
                // é€£çµ HTML è™•ç†
                const mapLink = event.mapURL ? 
                    `<a href="${event.mapURL}" target="_blank" class="text-blue-500 hover:underline flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13 18a2 2 0 1 1-4 0"/></svg>
                        åœ°åœ–
                    </a>` : '';
                const noteLink = event.noteURL ? 
                    `<a href="${event.noteURL}" target="_blank" class="text-green-600 hover:underline flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6m-3 7h-6m3-3v6"/></svg>
                        å‚™è¨»/é è¨‚
                    </a>` : '';

                // ç·¨è¼¯æ¨¡å¼æŒ‰éˆ•
                let editActionsHtml = '';
                if (isEditMode) {
                    editActionsHtml = `
                        <button onclick="startEditEvent(${dayIndex}, ${eventIndex})" class="action-btn edit-btn flex items-center">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                             ç·¨è¼¯
                        </button>
                        <button onclick="deleteEvent(${dayIndex}, ${eventIndex})" class="action-btn delete-btn flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m-6 5v6m4-6v6"/></svg>
                            åˆªé™¤
                        </button>
                    `;
                }

                const eventHtml = `
                    <div class="event-card ${isCompleted ? 'completed' : ''}" data-day="${dayIndex}" data-index="${eventIndex}">
                        
                        <!-- å·¦å´æ™‚é–“èˆ‡å®Œæˆç‹€æ…‹ -->
                        <div class="flex flex-col items-center flex-shrink-0">
                            <button onclick="toggleComplete(${dayIndex}, ${eventIndex})" 
                                    class="text-gray-400 hover:text-green-500 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${isCompleted ? 'text-green-500' : 'text-gray-400'}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm3.707 7.707-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L11 12.586l3.293-3.293a1 1 0 0 1 1.414 1.414z"/></svg>
                            </button>
                            <div class="event-time mt-1">${event.time}</div>
                        </div>

                        <!-- ä¸­é–“å…§å®¹ -->
                        <div class="event-details">
                            <div class="event-location">${highlightKeywords(event.location)}</div>
                            <div class="flex gap-4 text-xs mt-1 text-gray-500 dark:text-gray-300">
                                <span class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 11h2l-2 3M17 11v-4M17 11h-2m-2-2h-2l-2 3M13 7v-4M13 7h-2M13 7h2m-4 4h-2l-2 3M9 11v-4M9 11h-2M9 11h2m-4 4h-2l-2 3M5 15v-4M5 15h-2M5 15h2"/></svg>
                                    ${event.transport}
                                </span>
                                ${mapLink}
                                ${noteLink}
                            </div>
                            <div class="event-info text-sm text-gray-700 dark:text-gray-200">${event.notes || ''}</div>
                        </div>

                        <!-- å³å´èŠ±è²»å’Œç·¨è¼¯æŒ‰éˆ• -->
                        <div class="event-actions">
                            <div class="text-xs font-medium text-gray-500 dark:text-gray-400">é ä¼°: THB ${event.cost}</div>
                            ${costHtml}
                            ${editActionsHtml}
                        </div>
                    </div>
                `;
                eventList.insertAdjacentHTML('beforeend', eventHtml);
            });

            // æ›´æ–°ç¸½çµå€å¡Š
            document.getElementById(`estimated-cost-${dayIndex}`).textContent = totalEstimatedCost;
            document.getElementById(`actual-cost-${dayIndex}`).textContent = totalActualCost;
            
            container.appendChild(daySection);
            
            // æ¯æ¬¡æ¸²æŸ“å¾Œæ›´æ–°å°èˆªç‹€æ…‹
            updateNavState();
        }

        /**
         * å°‡æ™‚é–“å­—ä¸²è½‰æ›ç‚ºå¯æ’åºçš„æ•¸å­—
         */
        function getSortableTime(time) {
            if (!time) return 99999; // å°‡ç„¡æ™‚é–“çš„é …ç›®æ’åˆ°æœ€å¾Œ
            const [start, end] = time.split('-');
            const [hours, minutes] = start.split(':').map(Number);
            return hours * 60 + minutes;
        }

        /**
         * æ ¹æ“šæ™‚é–“å°è¡Œç¨‹é€²è¡Œæ’åº
         */
        function sortEventsByTime(events) {
            events.sort((a, b) => getSortableTime(a.time) - getSortableTime(b.time));
        }

        /**
         * é«˜äº®åœ°é»åç¨±ä¸­çš„é—œéµå­— (ä¾‹å¦‚ï¼šBTS, MRT)
         */
        function highlightKeywords(location) {
            if (!location) return '';
            const keywords = ['BTS', 'MRT', 'æ©Ÿå ´', 'é…’åº—', 'é£¯åº—', 'æ·é‹'];
            let result = location;
            keywords.forEach(keyword => {
                const regex = new RegExp(`(${keyword})`, 'gi');
                result = result.replace(regex, `<span class="bg-yellow-200 dark:bg-yellow-600 font-bold rounded-sm p-0.5">$1</span>`);
            });
            return result;
        }

        // --- ç·¨è¼¯æ¨¡å¼æ§åˆ¶ (æ‚¨æä¾›çš„éƒ¨åˆ†) ---

        /**
         * åˆ‡æ›ç·¨è¼¯æ¨¡å¼çš„ UI
         */
        function updateEditButtonUI() {
            const btn = document.getElementById('edit-toggle-btn');
            const icon = document.getElementById('edit-icon');
            
            if (isEditMode) {
                btn.classList.add('bg-red-500', 'text-white', 'shadow-lg');
                btn.classList.remove('text-gray-500');
                btn.title = "å„²å­˜ä¸¦é€€å‡ºç·¨è¼¯æ¨¡å¼";
                // æ›¿æ›ç‚ºå„²å­˜åœ–æ¨™ (Save/Disk)
                icon.innerHTML = `<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>`;
            } else {
                btn.classList.remove('bg-red-500', 'text-white', 'shadow-lg');
                btn.classList.add('text-gray-500');
                btn.title = "åˆ‡æ›ç·¨è¼¯æ¨¡å¼";
                // æ›¿æ›ç‚ºé‰›ç­†åœ–æ¨™ (Edit)
                icon.innerHTML = `<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>`;
            }
        }

        /**
         * é–‹å•Ÿç·¨è¼¯å½ˆçª—
         */
        function openEditModal(dayIndex, eventIndex = -1, event = {}) {
            document.getElementById('edit-modal').classList.add('open');
            document.getElementById('modal-title').textContent = eventIndex === -1 ? 'æ–°å¢è¡Œç¨‹' : 'ç·¨è¼¯è¡Œç¨‹';

            // è¨­ç½®éš±è—æ¬„ä½
            document.getElementById('event-day-index').value = dayIndex;
            document.getElementById('event-index').value = eventIndex;

            // å¡«å……è¡¨å–®
            document.getElementById('event-time-input').value = event.time || '';
            document.getElementById('event-location-input').value = event.location || '';
            document.getElementById('event-map-url-input').value = event.mapURL || '';
            document.getElementById('event-note-url-input').value = event.noteURL || '';
            document.getElementById('event-transport-input').value = event.transport || '';
            document.getElementById('event-estimated-cost-input').value = event.cost || '0';
            document.getElementById('event-notes-input').value = event.notes || '';
        }

        /**
         * é—œé–‰ç·¨è¼¯å½ˆçª—
         */
        window.closeEditModal = function() {
            document.getElementById('edit-modal').classList.remove('open');
            document.getElementById('event-form').reset();
        }

        /**
         * é–‹å§‹ç·¨è¼¯ç¾æœ‰è¡Œç¨‹
         */
        window.startEditEvent = function(dayIndex, eventIndex) {
            const event = appData.days[dayIndex].events[eventIndex];
            openEditModal(dayIndex, eventIndex, event);
        }

        /**
         * é–‹å§‹æ–°å¢è¡Œç¨‹
         */
        window.startAddEvent = function(dayIndex) {
            openEditModal(dayIndex, -1, {});
        }
        
        // å„²å­˜äº‹ä»¶è™•ç† (æ‚¨æä¾›çš„éƒ¨åˆ†)
        function handleSaveEvent(e) {
            e.preventDefault();
            
            const dayIndex = parseInt(document.getElementById('event-day-index').value);
            const eventIndex = parseInt(document.getElementById('event-index').value);

            const newEvent = {
                time: document.getElementById('event-time-input').value,
                location: document.getElementById('event-location-input').value,
                mapURL: document.getElementById('event-map-url-input').value.trim(),
                noteURL: document.getElementById('event-note-url-input').value.trim(),
                transport: document.getElementById('event-transport-input').value,
                cost: document.getElementById('event-estimated-cost-input').value || '0',
                notes: document.getElementById('event-notes-input').value
            };

            if (eventIndex === -1) {
                // æ–°å¢
                appData.days[dayIndex].events.push(newEvent);
                showToast('âœ¨ è¡Œç¨‹å·²æ–°å¢è‡³æœ¬åœ°æ•¸æ“šã€‚');
            } else {
                // ä¿®æ”¹
                appData.days[dayIndex].events[eventIndex] = newEvent;
                showToast('ğŸ“ è¡Œç¨‹å·²æ›´æ–°è‡³æœ¬åœ°æ•¸æ“šã€‚');
            }

            // æ’åºç•¶æ—¥æ‰€æœ‰è¡Œç¨‹
            sortEventsByTime(appData.days[dayIndex].events);

            closeEditModal();
            renderDay(dayIndex);
        }

        // åˆªé™¤äº‹ä»¶è™•ç† (æ‚¨æä¾›çš„éƒ¨åˆ† - å·²å°‡ confirm æ›¿æ›ç‚ºè‡ªå®šç¾© modal æ¦‚å¿µï¼Œé€™è£¡ç”¨ window.confirm æš«ä»£)
        window.deleteEvent = function(dayIndex, eventIndex) {
            // æ³¨æ„ï¼šåœ¨å¯¦éš›çš„ Canvas ç’°å¢ƒä¸­ï¼Œæ‡‰è©²ä½¿ç”¨è‡ªå®šç¾© modal å–ä»£ window.confirm
            if(!window.confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ")) return;

            // ç§»é™¤è¡Œç¨‹
            appData.days[dayIndex].events.splice(eventIndex, 1);
            showToast('ğŸ—‘ï¸ è¡Œç¨‹å·²å¾æœ¬åœ°æ•¸æ“šåˆªé™¤ã€‚');

            // åˆªé™¤ç›¸é—œçš„ LocalStorage æ•¸æ“š (è¨˜å¸³/å®Œæˆç‹€æ…‹)
            localStorage.removeItem(`trip_d${dayIndex}_e${eventIndex}${CHECK_KEY_SUFFIX}`);
            localStorage.removeItem(`trip_d${dayIndex}_e${eventIndex}${COST_KEY_SUFFIX}`);
            
            // é‡æ–°æ’åºä¸¦æ¸²æŸ“
            sortEventsByTime(appData.days[dayIndex].events);
            renderDay(dayIndex);
        }
        
        // --- è¨˜å¸³èˆ‡å®Œæˆç‹€æ…‹åŠŸèƒ½ (ç¼ºå¤±éƒ¨åˆ†) ---

        /**
         * åˆ‡æ›è¡Œç¨‹çš„å®Œæˆç‹€æ…‹
         */
        window.toggleComplete = function(dayIndex, eventIndex) {
            const key = `trip_d${dayIndex}_e${eventIndex}${CHECK_KEY_SUFFIX}`;
            const isCompleted = localStorage.getItem(key) === 'true';
            
            if (isCompleted) {
                localStorage.removeItem(key);
                showToast('â° è¡Œç¨‹æ¨™è¨˜ç‚ºæœªå®Œæˆã€‚');
            } else {
                localStorage.setItem(key, 'true');
                showToast('âœ… è¡Œç¨‹å·²å®Œæˆï¼');
            }
            renderDay(dayIndex);
        }

        /**
         * å•Ÿç”¨å¯¦éš›èŠ±è²»ç·¨è¼¯
         */
        window.enableCostEdit = function(dayIndex, eventIndex, defaultCost) {
            const displayId = `cost-display-${dayIndex}-${eventIndex}`;
            const displayElement = document.getElementById(displayId);
            
            // é¿å…é‡è¤‡ç·¨è¼¯
            if (displayElement.querySelector('input')) return;

            const currentCost = localStorage.getItem(`trip_d${dayIndex}_e${eventIndex}${COST_KEY_SUFFIX}`) || defaultCost;
            
            displayElement.innerHTML = `
                <input type="number" 
                       id="cost-input-${dayIndex}-${eventIndex}" 
                       value="${currentCost}" 
                       min="0"
                       class="w-20 p-1 text-sm border border-blue-400 rounded-md text-gray-800"
                       onblur="saveCost(${dayIndex}, ${eventIndex}, ${defaultCost})"
                       onkeydown="if(event.key === 'Enter'){ saveCost(${dayIndex}, ${eventIndex}, ${defaultCost}); event.target.blur(); }">
            `;
            // ç„¦é»ç§»åˆ°è¼¸å…¥æ¡†
            document.getElementById(`cost-input-${dayIndex}-${eventIndex}`).focus();
        }

        /**
         * å„²å­˜å¯¦éš›èŠ±è²»
         */
        window.saveCost = function(dayIndex, eventIndex, defaultCost) {
            const inputId = `cost-input-${dayIndex}-${eventIndex}`;
            const inputElement = document.getElementById(inputId);
            const displayId = `cost-display-${dayIndex}-${eventIndex}`;
            const displayElement = document.getElementById(displayId);

            if (!inputElement) return;

            let newCost = parseInt(inputElement.value || 0);
            
            localStorage.setItem(`trip_d${dayIndex}_e${eventIndex}${COST_KEY_SUFFIX}`, newCost);

            // é‡æ–°æ¸²æŸ“é¡¯ç¤ºå…ƒç´ 
            displayElement.innerHTML = `THB ${newCost}`;
            displayElement.className = 'cost-display cursor-pointer';

            showToast(`ğŸ’° å¯¦éš›èŠ±è²»å·²æ›´æ–°ç‚º THB ${newCost}`);
            renderDay(dayIndex); // é‡æ–°è¨ˆç®—ç¸½å’Œ
        }

        /**
         * é‡è¨­ç•¶å¤©æ‰€æœ‰è¡Œç¨‹çš„å¯¦éš›èŠ±è²»
         */
        window.resetDailyCosts = function(dayIndex) {
            if(!window.confirm(`ç¢ºå®šè¦å°‡ Day ${dayIndex + 1} çš„æ‰€æœ‰å¯¦éš›èŠ±è²»é‡è¨­ç‚ºé ä¼°å€¼å—ï¼Ÿé€™æœƒæ¸…é™¤æ‰€æœ‰ç´€éŒ„ã€‚`)) return;

            appData.days[dayIndex].events.forEach((event, eventIndex) => {
                localStorage.removeItem(`trip_d${dayIndex}_e${eventIndex}${COST_KEY_SUFFIX}`);
            });
            showToast('ğŸ”„ æ¯æ—¥èŠ±è²»å·²é‡è¨­ã€‚');
            renderDay(dayIndex);
        }
        
        // --- ä¸»é¡Œåˆ‡æ›åŠŸèƒ½ (ç¼ºå¤±éƒ¨åˆ†) ---
        
        /**
         * åˆ‡æ›æ·±è‰²/æ·ºè‰²ä¸»é¡Œ
         */
        window.toggleTheme = function() {
            const isDark = document.documentElement.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        /**
         * æ›´æ–°ä¸»é¡ŒæŒ‰éˆ•çš„åœ–æ¨™
         */
        function updateThemeIcon(isDark) {
            const icon = document.getElementById('theme-icon');
            if (isDark) {
                // æœˆäº®åœ–æ¨™ (Dark Mode)
                icon.innerHTML = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`;
            } else {
                // å¤ªé™½åœ–æ¨™ (Light Mode)
                icon.innerHTML = `<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>`;
            }
        }

        // --- å•Ÿå‹•å‡½å¼ ---
        function initApp() {
            determineInitialDay();
            renderNavigation();
            renderDay(currentDayIndex);
            updateEditButtonUI();
        }

    </script>
</body>
</html>
